import{e as we,k as g,f as O,b8 as Be,b9 as _e,l as ee,az as Ee,b6 as je,r as me,o as G,c as te,d as E,F as he,C as Ge,g as fe,u as L,n as Ve,E as ye,aC as Oe,ba as We,aj as De,a as V,p as Ke,b as He,A as B,bb as ce,b7 as Pe,b5 as Ue,i as Ye}from"./vendor.20f3e3c2.js";import{M as Je,R as Qe,s as Xe,p as xe,a as P,c as Ze,b as et}from"./Radar.bbf8addf.js";import{_ as $e,A as tt,E as at}from"./index.fdb75d7c.js";const st=M=>(Ke("data-v-99092c60"),M=M(),He(),M),nt=st(()=>E("svg",{class:"radar__canvas"},[E("g",{class:"radar__edge-container"}),E("g",{class:"radar__ring-container"})],-1)),rt={class:"radar__node-container"},ot={class:"radar__minimap-controls-container"},it={class:"mb-1 d-flex align-center justify-end"},ct={class:"radar__minimap-container"},lt=we({props:{items:null,id:null},setup(M){const w=M,$=g(w.items),h=g(),q=g(),W=g(),F=g(),ae=g(),U=O(()=>{const t=[...N.value.entries()];return new Map([...u.value.nodes.entries()].filter(([,s])=>t.every(([,i])=>!i.get(s.id))).filter(([,s])=>{var a;if(!u.value.rings.get(s.ring))return;const{position:n}=s;if(!n)return;const r=[...n.nodes.values()];return((a=r==null?void 0:r[0])==null?void 0:a.id)==s.id}))}),ke=O(()=>{const t=new Set([...U.value.entries()].map(([,s])=>s.ring));return new Map([...u.value.rings.entries()].filter(([s])=>t.has(s)))}),se=O(()=>{const t=[...N.value.entries()];return u.value.links.filter(s=>t.every(([,i])=>!i.get(s.target.id))).filter(s=>U.value.get(s.source.id)&&U.value.get(s.target.id))}),be=({transform:t})=>{var i,n,r;const s=`translate(${t.x}px, ${t.y}px) scale(${t.k})`;(i=F.value)==null||i.style("transform",s),(n=W.value)==null||n.style("transform",s),(r=ae.value)==null||r.style("transform",s),de.value=t},ze=t=>{u.value.expandRing(t.ring)},Ce=t=>{if(N.value.get(t.id))N.value.delete(t.id);else{const s=u.value.traverse(t);N.value.set(t.id,s)}},Re=()=>{var i;const t=(n,r,a,v)=>{const _=v*(P/180),e=n+a*Ze(_)||0,l=r+a*et(_)||0;return[e,l]},s=([,n],r=1)=>{const a=n.radius,_=125*360/(2*P*a),e=b.value/2*r,l=k.value/2*r,[o,m]=t(e,l,a,90-_),[z,D]=t(e,l,a,90+_);return`M ${o} ${m} A${n.radius} ${n.radius} 0 1 0 ${z} ${D}`};(i=F.value)==null||i.selectAll(".radar__ring").data(ke.value).join(n=>{const r=n.append("g");return r.attr("id",v=>v.id),r.attr("class","radar__ring").append("path").attr("id",([v])=>v).attr("d",v=>s(v,1)).style("opacity",1).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.03)").attr("stroke-width",80),r},n=>(n.select("path").attr("id",([a])=>a).attr("d",a=>s(a,1)),n),n=>n.remove())},Y=()=>{var _;const t=(e,l,o,m,z)=>{const D=Xe(xe(o-e,2)+xe(m-l,2)),c=z/D,C=(1-c)*e+c*o,R=(1-c)*l+c*m;return[C,R]},s=(e,l)=>{const o=Ue(),m=P/2,z=3*P/2,D=0,c=u.value.rings.get(e.source.ring),C=u.value.rings.get(e.target.ring),R=u.value.rings.get(e.target.ring-1),ve=u.value.rings.get(e.source.ring+1),ge=c.links,Ne=ge.findIndex(p=>p.source.id==e.source.id&&p.target.id==e.target.id),y=b.value/2,A=k.value/2,ie=(C.radius-c.radius)/2,Se=ie/ge.length,pe=Ne*Se,J=e.target.cx,Q=e.target.cy,I=e.target.radian,X=e.source.cx,Z=e.source.cy,T=e.source.radian;let K,H;if(c.radius==0){const[p,x]=t(y,A,J,Q,C.radius-c.radius);K=p,H=x}else if(e.target.ring-e.source.ring===1){const[p,x]=t(y,A,X,Z,c.radius+ie*1.25-pe);K=p,H=x}else{const[p,x]=t(y,A,X,Z,c.radius+(ve.radius-c.radius)/2);K=p,H=x}if(o.moveTo(X,Z),e.target.ring-e.source.ring>1){c.radius!==0&&(o.lineTo(K,H),o.arc(y,A,c.radius+(ve.radius-c.radius)/2,T,m,T<z&&T>D));const p=R.radius+(C.radius-R.radius)/2,[x,j]=t(y,A,y,p,R.radius+(C.radius-R.radius)/2);o.lineTo(x,j),o.arc(y,A,R.radius+(C.radius-R.radius)/2,m,I,I>z||I<m)}else{o.lineTo(K,H);const[p,x]=t(y,A,J,Q,C.radius-c.radius);if(J!==X&&Q!==Z&&c.radius!==0){const j=P/2;o.arc(y,A,c.radius+ie*1.25-pe,T,I,T>j&&I>j&&I<T||T<j&&(I>j||I<T))}else o.moveTo(p,x)}return o.lineTo(J,Q),o.toString()},i=e=>{const l=u.value.rings.get(e.source.ring),o=u.value.rings.get(e.target.ring),m=l.links,z=(o.radius-l.radius)/m.length;return Math.min(5,z)},n=e=>{const l=d.includes(e.source.id)||d.includes(e.target.id),o=f.value&&(e.source.id==f.value||e.target.id==f.value);return l||o},r=e=>!f.value&&d.length===0||n(e)?1:.2,a=e=>`${e.source.id}---${e.target.id}`,v=e=>{const l=["radar__edge"];return(n(e)||d.length==0&&!f.value)&&l.push(`${e.source.data.state.type.toLowerCase()}-stroke`),se.value.length<100&&l.push("radar__edge--transition"),l.join(" ")};(_=W.value)==null||_.selectAll(".radar__edge").data(se.value).join(e=>e.append("path").attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",r),e=>e.attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",r),e=>e.remove())},ne=()=>{Re(),Y()},le=t=>{f.value==t?f.value=void 0:f.value=t,requestAnimationFrame(()=>Y())},ue=t=>{const s=d.indexOf(t);s>-1?d.splice(s,1):d.push(t)},Ae=t=>{requestAnimationFrame(()=>{B(".radar__canvas").transition().duration(200).call(S.value.transform,t)})},Ie=({x:t,y:s})=>{S.value.translateBy(B(".radar__canvas"),t,s)},Te=()=>{d.length=0},re=()=>{B(".radar__canvas").transition().ease(ce).duration(250).call(S.value.transform,Pe)},Le=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),1.35)})},Me=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),.65)})},k=g(0),b=g(0),f=g(),d=Be([]),de=g({x:0,y:0,k:1}),N=g(new Map),u=g(new Qe),S=g(_e());ee(()=>[w.items,w.id],(t,s)=>{const[i,n]=t,[r,a]=s;$.value=w.items,u.value.items($.value),(i.length>0&&r.length==0||n!==a)&&(u.value.center([b.value/2,k.value/2]),d.length=0,re()),i.length!==r.length||n!==a?requestAnimationFrame(()=>ne()):requestAnimationFrame(()=>Y())}),ee(d,()=>{requestAnimationFrame(()=>Y())}),ee(se,()=>{requestAnimationFrame(()=>ne())});const oe=()=>{!h.value||(k.value=h.value.offsetHeight,b.value=h.value.offsetWidth)},qe=()=>{var t;q.value=B(".radar__canvas"),F.value=q.value.select(".radar__ring-container"),W.value=q.value.select(".radar__edge-container"),ae.value=B(".radar__node-container"),S.value=_e().extent([[0,0],[b.value,k.value]]).on("zoom",be),(t=q.value)==null||t.attr("viewbox",`0, 0, ${b.value}, ${k.value}`).call(S.value),ne(),re()},Fe=t=>{t.preventDefault(),h.value&&(h.value.scrollTop=0,h.value.scrollLeft=0)};return Ee(()=>{oe(),window.addEventListener("resize",oe),u.value.id("id").dependencies("upstream_dependencies").center([b.value/2,k.value/2]).items($.value),qe()}),je(()=>{window.removeEventListener("resize",oe)}),(t,s)=>{const i=me("radar-overflow-node"),n=me("icon-button");return G(),te("div",{ref_key:"container",ref:h,class:"radar",onScroll:Fe},[nt,E("div",rt,[(G(!0),te(he,null,Ge(L(U),([r,a])=>{var v,_;return G(),te(he,{key:r},[((v=a.position)==null?void 0:v.nodes.size)==1?(G(),fe(De(a.data.state.state_details.child_flow_run_id?"radar-flow-run-node":"radar-node"),{key:0,id:`node-${r}`,node:a,selected:L(d).includes(a.id),class:Ve(["radar__node position-absolute",{"radar__node--transparent":L(d).length>0&&!L(d).includes(a.id)&&f.value!==a.id,"radar__node--deemphasized":L(d).length>0&&L(d).some(e=>a.upstreamNodes.get(e)||a.downstreamNodes.get(e))}]),collapsed:N.value.get(r),style:ye({left:`${a.cx}px`,top:`${a.cy}px`}),tabindex:"0",onToggleTree:Ce,onClick:Oe(e=>ue(a.id),["stop"]),onKeyup:We(e=>ue(a.id),["space","enter"]),onMouseover:e=>le(a.id),onMouseout:e=>le(a.id)},null,8,["id","node","selected","class","collapsed","style","onClick","onKeyup","onMouseover","onMouseout"])):(G(),fe(i,{key:1,class:"position-absolute",nodes:(_=a.position)==null?void 0:_.nodes,style:ye({left:`${a.cx}px`,top:`${a.cy}px`}),tabindex:"0",onClick:e=>ze(a)},null,8,["nodes","style","onClick"]))],64)}),128))]),E("div",ot,[E("div",it,[V(n,{class:"bg--white justify-self-start mr-auto",icon:"pi-restart-line",onClick:Te}),V(n,{class:"bg--white mr-1",icon:"pi-zoom-in-line",onClick:Le}),V(n,{class:"bg--white mr-1",icon:"pi-zoom-out-line",onClick:Me}),V(n,{class:"bg--white",icon:"pi-fullscreen-fill",onClick:re})]),E("div",ct,[V(Je,{id:M.id,class:"radar__minimap position-relative",transform:de.value,"collapsed-trees":N.value,radar:u.value,height:k.value,width:b.value,onDragViewport:Ie,onPanToLocation:Ae},null,8,["id","transform","collapsed-trees","radar","height","width"])])])],544)}}});var ut=$e(lt,[["__scopeId","data-v-99092c60"]]);const dt={class:"radar z-0"},vt=we({setup(M){const w=Ye(),$=O(()=>w==null?void 0:w.params.id),h=O(()=>({id:$.value})),q={radar:tt.query({endpoint:at.radar,body:h,options:{pollInterval:5e3}})},W=O(()=>{var F;return((F=q.radar.response)==null?void 0:F.value)||[]});return ee($,()=>{!$.value||q.radar.fetch()}),(F,ae)=>(G(),te("div",dt,[V(ut,{id:L($),items:L(W)},null,8,["id","items"])]))}});var mt=$e(vt,[["__scopeId","data-v-c7dcd594"]]);export{mt as default};
