"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_components_modals_widgetViewerModal_utils_tsx-app_views_dashboardsV2_widgetCard_widgetCar-7a3063"],{"./app/actionCreators/metrics.tsx":(e,t,s)=>{s.d(t,{bf:()=>g,mX:()=>h,dp:()=>f}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var r=s("./app/actionCreators/indicator.tsx"),i=s("./app/actions/metricsMetaActions.tsx"),n=s("./app/actions/metricTagActions.tsx"),o=s("./app/components/charts/utils.tsx"),a=s("./app/components/organizations/pageFilters/parse.tsx"),l=s("./app/locale.tsx"),d=s("./app/stores/metricsMetaStore.tsx"),u=s("./app/stores/metricsTagStore.tsx"),c=s("./app/utils.tsx"),p=s("./app/utils/handleXhrErrorResponse.tsx");const g=(e,t)=>{let{field:s,orgSlug:r,cursor:i,environment:n,groupBy:l,interval:d,limit:u,orderBy:p,project:g,query:m,includeAllArgs:h=!1,statsPeriodStart:v,statsPeriodEnd:f,...y}=t;const{start:b,end:w,statsPeriod:x}=(0,a.fK)(y,{allowEmptyPeriod:!0}),Z=Object.fromEntries(Object.entries({field:s.filter((e=>!!e)),cursor:i,end:w,environment:n,groupBy:null==l?void 0:l.filter((e=>!!e)),interval:d||(0,o.ZS)({start:b,end:w,period:x}),query:m||void 0,per_page:u,project:g,orderBy:p,start:b,statsPeriod:x,statsPeriodStart:v,statsPeriodEnd:f}).filter((e=>{let[,t]=e;return(0,c.ri)(t)&&""!==t}))),R=`/organizations/${r}/metrics/data/`;return e.requestPromise(R,{includeAllArgs:h,query:Z})};function m(e){n.Z.loadMetricsTagsSuccess(e)}function h(e,t,s,i){u.Z.reset();const n=e.requestPromise(`/organizations/${t}/metrics/tags/`,{query:{project:s,metric:i}});return n.then(m).catch((e=>{var t;const s=null!==(t=null==e?void 0:e.responseJSON)&&void 0!==t?t:(0,l.t)("Unable to fetch metric tags");(0,r.Iw)(s),(0,p.Z)(s)(e)})),n}function v(e){i.Z.loadMetricsMetaSuccess(e)}function f(e,t,s){d.Z.reset();const i=e.requestPromise(`/organizations/${t}/metrics/meta/`,{query:{project:s}});return i.then(v).catch((e=>{var t;const s=null!==(t=null==e?void 0:e.responseJSON)&&void 0!==t?t:(0,l.t)("Unable to fetch metric fields");(0,r.Iw)(s),(0,p.Z)(s)(e)})),i}},"./app/actions/metricTagActions.tsx":(e,t,s)=>{s.d(t,{Z:()=>i});var r=s("../node_modules/reflux/src/index.js");const i=s.n(r)().createActions(["loadMetricsTagsSuccess"])},"./app/actions/metricsMetaActions.tsx":(e,t,s)=>{s.d(t,{Z:()=>i});var r=s("../node_modules/reflux/src/index.js");const i=s.n(r)().createActions(["loadMetricsMetaSuccess"])},"./app/components/modals/widgetViewerModal/utils.tsx":(e,t,s)=>{let r;function i(e){return e.match(/\/widget\/[0-9]+\/$/)}s.d(t,{R:()=>r,X:()=>i}),function(e){e.SORT="sort",e.QUERY="query",e.LEGEND="legend",e.PAGE="page",e.CURSOR="cursor"}(r||(r={}))},"./app/stores/metricsMetaStore.tsx":(e,t,s)=>{s.d(t,{Z:()=>a});var r=s("../node_modules/reflux/src/index.js"),i=s.n(r),n=s("./app/actions/metricsMetaActions.tsx");const o={metricsMeta:{},init(){this.listenTo(n.Z.loadMetricsMetaSuccess,this.onLoadSuccess)},reset(){this.metricsMeta={},this.trigger(this.metricsMeta)},getState(){const{metricsMeta:e}=this;return{metricsMeta:e}},onLoadSuccess(e){const t=e.reduce(((e,t)=>(e[t.name]={...t},e)),{});this.metricsMeta={...this.metricsMeta,...t},this.trigger(this.metricsMeta)}},a=i().createStore(o)},"./app/stores/metricsTagStore.tsx":(e,t,s)=>{s.d(t,{Z:()=>a});var r=s("../node_modules/reflux/src/index.js"),i=s.n(r),n=s("./app/actions/metricTagActions.tsx");const o={metricsTags:{},init(){this.listenTo(n.Z.loadMetricsTagsSuccess,this.onLoadSuccess)},reset(){this.metricsTags={},this.trigger(this.metricsTags)},getState(){const{metricsTags:e}=this;return{metricsTags:e}},onLoadSuccess(e){const t=e.reduce(((e,t)=>(e[t.key]={...t},e)),{});this.metricsTags={...this.metricsTags,...t},this.trigger(this.metricsTags)}},a=i().createStore(o)},"./app/utils/dashboards/issueFieldRenderers.tsx":(e,t,s)=>{s.d(t,{N:()=>x,O:()=>T});var r=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),i=s("../node_modules/react/index.js"),n=s("./app/components/assigneeSelector.tsx"),o=s("./app/components/count.tsx"),a=s("./app/components/links/link.tsx"),l=s("./app/components/organizations/timeRangeSelector/utils.tsx"),d=s("./app/components/tooltip.tsx"),u=s("./app/constants/index.tsx"),c=s("./app/locale.tsx"),p=s("./app/stores/memberListStore.tsx"),g=s("./app/styles/space.tsx"),m=s("./app/utils/discover/eventView.tsx"),h=s("./app/views/dashboardsV2/widgetBuilder/issueWidget/fields.tsx"),v=s("./app/utils/discover/styles.tsx"),f=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const y={issue:{sortField:null,renderFunc:(e,t)=>{let{organization:s}=t;const r=e["issue.id"];if(!r)return(0,f.tZ)(v.W2,{children:(0,f.tZ)(v.PV,{shortId:`${e.issue}`})});const i={pathname:`/organizations/${s.slug}/issues/${r}/`};return(0,f.tZ)(v.W2,{children:(0,f.tZ)(v.Jo,{to:i,"aria-label":r,children:(0,f.tZ)(v.PV,{shortId:`${e.issue}`})})})}},assignee:{sortField:null,renderFunc:e=>{const t=p.Z.getAll();return(0,f.tZ)(q,{children:(0,f.tZ)(n.Z,{id:e.id,memberList:t,noDropdown:!0})})}},lifetimeEvents:{sortField:null,renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"lifetimeEvents")}},lifetimeUsers:{sortField:null,renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"lifetimeUsers")}},events:{sortField:"freq",renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"events")}},users:{sortField:"user",renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"users")}},lifetimeCount:{sortField:null,renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"lifetimeEvents")}},lifetimeUserCount:{sortField:null,renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"lifetimeUsers")}},count:{sortField:null,renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"events")}},userCount:{sortField:null,renderFunc:(e,t)=>{let{organization:s}=t;return b(e,s,"users")}},links:{sortField:null,renderFunc:e=>{let{links:t}=e;return(0,f.tZ)(F,{dangerouslySetInnerHTML:{__html:t}})}}},b=(e,t,s)=>{const{start:r,end:n,period:a}=e,p=!!/user/i.exec(s.toLowerCase()),g=e[s],m=e[p?"users":"events"],h=e[p?"lifetimeUsers":"lifetimeEvents"],y=e[p?"filteredUsers":"filteredEvents"],b=w(e,t),x=w(e,t,!0),Z=r&&n?"time range":(0,l.T)(a||u.GY).toLowerCase();return(0,f.tZ)(v.W2,{children:(0,f.tZ)(d.Z,{isHoverable:!0,skipWrapper:!0,popperStyle:{padding:0},title:(0,f.BX)("div",{children:[y?(0,f.BX)(i.Fragment,{children:[(0,f.BX)(S,{to:x,children:[(0,c.t)("Matching search filters"),(0,f.tZ)(_,{value:y})]}),(0,f.tZ)(j,{})]}):null,(0,f.BX)(S,{to:b,children:[(0,c.t)(`Total in ${Z}`),(0,f.tZ)(_,{value:m})]}),(0,f.tZ)(j,{}),(0,f.BX)(R,{children:[(0,c.t)("Since issue began"),(0,f.tZ)(_,{value:h})]})]}),children:(0,f.tZ)("span",{children:["events","users"].includes(s)&&y?(0,f.BX)(i.Fragment,{children:[(0,f.tZ)(o.Z,{value:y}),(0,f.tZ)(M,{value:g})]}):(0,f.tZ)(o.Z,{value:g})})})})};b.displayName="issuesCountRenderer";const w=(e,t,s)=>{const r={projects:[Number(e.projectId)]};return m.ZP.fromSavedQuery({...r,id:void 0,start:e.start,end:e.end,range:e.period,name:e.title,fields:["title","release","environment","user","timestamp"],orderby:"-timestamp",query:`issue.id:${e.id}${s?e.discoverSearchQuery:""}`,version:2}).getResultsViewUrlTarget(t.slug)};function x(e){if(y.hasOwnProperty(e))return y[e].sortField;switch(e){case h.Sh.LAST_SEEN:return"date";case h.Sh.FIRST_SEEN:return"new";default:return null}}const Z={name:"s5gdgx",styles:"width:100%;justify-content:space-between;display:flex;padding:6px 10px"},R=(0,r.Z)("div",{target:"e1va53iy6"})(Z,";"),S=(0,r.Z)(a.Z,{target:"e1va53iy5"})(Z,";color:",(e=>e.theme.gray400),";&:hover{color:",(e=>e.theme.gray400),";background:",(e=>e.theme.hover),";}"),M=(0,r.Z)(o.Z,{target:"e1va53iy4"})(":before{content:'/';padding-left:",(0,g.Z)(.25),";padding-right:2px;}"),_=(0,r.Z)((e=>{let{value:t,...s}=e;return(0,f.tZ)("div",{...s,children:(0,f.tZ)(o.Z,{value:t})})}),{target:"e1va53iy3"})("text-align:right;font-weight:bold;font-variant-numeric:tabular-nums;padding-left:",(0,g.Z)(2),";color:",(e=>e.theme.subText),";"),j=(0,r.Z)("div",{target:"e1va53iy2"})("height:1px;overflow:hidden;background-color:",(e=>e.theme.innerBorder),";"),q=(0,r.Z)("div",{target:"e1va53iy1"})({name:"1h3u8pb",styles:"display:flex;justify-content:left;margin-left:18px;:hover{cursor:default;}"}),F=(0,r.Z)("span",{target:"e1va53iy0"})({name:"1bmnxg7",styles:"white-space:nowrap"});function T(e){return y.hasOwnProperty(e)?y[e].renderFunc:null}},"./app/utils/discover/charts.tsx":(e,t,s)=>{s.d(t,{CX:()=>a,gu:()=>l});var r=s("./app/locale.tsx"),i=s("./app/utils.tsx"),n=s("./app/utils/discover/fields.tsx"),o=s("./app/utils/formatters.tsx");function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!(0,i.ri)(e))return"â€”";switch((0,n.Px)(t)){case"integer":case"number":return e.toLocaleString();case"percentage":return(0,o.rl)(e,2);case"duration":return(0,o.g9)(e/1e3,2,!0);default:return e.toString()}}function l(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch((0,n.Px)(t)){case"integer":case"number":return s?(0,o.Du)(e):e.toLocaleString();case"percentage":return(0,o.rl)(e,0);case"duration":return d(e);default:return e.toString()}}function d(e){if(0===e)return"0";if(e>=o.ps){const t=(e/o.ps).toFixed(0);return(0,r.t)("%swk",t)}if(e>=o.x4){const t=(e/o.x4).toFixed(0);return(0,r.t)("%sd",t)}if(e>=o.kr){const t=(e/o.kr).toFixed(0);return(0,r.t)("%shr",t)}if(e>=o.EB){const t=(e/o.EB).toFixed(0);return(0,r.t)("%smin",t)}if(e>=o.sh){const t=(e/o.sh).toFixed(0);return(0,r.t)("%ss",t)}const t=e.toFixed(0);return(0,r.t)("%sms",t)}},"./app/utils/discover/genericDiscoverQuery.tsx":(e,t,s)=>{s.d(t,{AA:()=>p,ZP:()=>g});var r=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/react/index.js")),n=s("./app/locale.tsx"),o=s("./app/utils/discover/eventView.tsx"),a=s("./app/utils/performance/contexts/performanceEventViewContext.tsx"),l=s("./app/utils/useOrganization.tsx"),d=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class u extends i.Component{constructor(){super(...arguments),(0,r.Z)(this,"state",{isLoading:!0,tableFetchID:void 0,error:null,tableData:null,pageLinks:null}),(0,r.Z)(this,"_shouldRefetchData",(e=>{const t=this.getPayload(this.props),s=this.getPayload(e);return!(0,o.ze)(t,s)||e.limit!==this.props.limit||e.route!==this.props.route||e.cursor!==this.props.cursor})),(0,r.Z)(this,"fetchData",(async()=>{const{api:e,beforeFetch:t,afterFetch:s,didFetch:r,eventView:i,orgSlug:o,route:a,setError:l}=this.props;if(!i.isValid())return;const d=`/organizations/${o}/${a}/`,u=Symbol("tableFetchID"),c=this.getPayload(this.props);this.setState({isLoading:!0,tableFetchID:u}),null==l||l(void 0),null==t||t(e),e.clear();try{const[t,,i]=await p(e,d,c);if(this.state.tableFetchID!==u)return;const n=s?s(t,this.props):t;null==r||r(n),this.setState((e=>{var t;return{isLoading:!1,tableFetchID:void 0,error:null,pageLinks:null!==(t=null==i?void 0:i.getResponseHeader("Link"))&&void 0!==t?t:e.pageLinks,tableData:n}}))}catch(e){var g;const t=(null==e||null===(g=e.responseJSON)||void 0===g?void 0:g.detail)||(0,n.t)("An unknown error occurred.");this.setState({isLoading:!1,tableFetchID:void 0,error:t,tableData:null}),l&&l(t)}}))}componentDidMount(){this.fetchData()}componentDidUpdate(e){const t=this._shouldRefetchData(e),s=!1===e.eventView.isValid()&&this.props.eventView.isValid(),r=!!this.props.shouldRefetchData&&this.props.shouldRefetchData(e,this.props);(t||s||r)&&this.fetchData()}getPayload(e){var t;const{cursor:s,limit:r,noPagination:i,referrer:n}=e,o=this.props.getRequestPayload?this.props.getRequestPayload(e):e.eventView.getEventsAPIPayload(e.location);return s&&(o.cursor=s),r&&(o.per_page=r),i&&(o.noPagination=i),n&&(o.referrer=n),Object.assign(o,null!==(t=e.queryExtras)&&void 0!==t?t:{}),o}render(){const{isLoading:e,error:t,tableData:s,pageLinks:r}=this.state,i={isLoading:e,error:t,tableData:s,pageLinks:r},n=this.props.children;return null==n?void 0:n(i)}}function c(e){var t,s;const r=null!==(t=e.orgSlug)&&void 0!==t?t:(0,l.Z)().slug,i=null!==(s=e.eventView)&&void 0!==s?s:(0,a.wj)(),n={...e,orgSlug:r,eventView:i};return(0,d.tZ)(u,{...n})}async function p(e,t,s){return e.requestPromise(t,{method:"GET",includeAllArgs:!0,query:{...s}})}u.displayName="_GenericDiscoverQuery",c.displayName="GenericDiscoverQuery";const g=c},"./app/utils/performance/contexts/performanceEventViewContext.tsx":(e,t,s)=>{s.d(t,{bq:()=>i,wj:()=>o}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var r=s("./app/utils/performance/contexts/utils.tsx");const[i,n]=(0,r.n)({name:"PerformanceEventViewContext"});function o(){return n().eventView}},"./app/utils/performance/contexts/utils.tsx":(e,t,s)=>{s.d(t,{n:()=>i});var r=s("../node_modules/react/index.js");function i(e){const{strict:t=!0,errorMessage:s=`useContext for "${e.name}" must be inside a Provider with a value`,name:i}=e,n=r.createContext(void 0);return n.displayName=i,[n.Provider,function(){const e=r.useContext(n);if(!e&&t)throw new Error(s);return e},n]}},"./app/views/dashboardsV2/utils.tsx":(e,t,s)=>{s.d(t,{qk:()=>Z,tT:()=>R,y1:()=>M,DW:()=>_,s:()=>j,Mf:()=>q,z1:()=>F,hS:()=>T}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var r=s("../node_modules/lodash/cloneDeep.js"),i=s.n(r),n=s("../node_modules/lodash/pick.js"),o=s.n(n),a=s("../node_modules/query-string/index.js"),l=s("./images/dashboard/widget-area.svg"),d=s("./images/dashboard/widget-bar.svg"),u=s("./images/dashboard/widget-big-number.svg"),c=s("./images/dashboard/widget-line-1.svg"),p=s("./images/dashboard/widget-table.svg"),g=s("./images/dashboard/widget-world-map.svg"),m=s("./app/components/arithmeticInput/parser.tsx"),h=s("./app/components/charts/utils.tsx"),v=s("./app/utils.tsx"),f=s("./app/utils/dates.tsx"),y=s("./app/utils/discover/eventView.tsx"),b=s("./app/utils/discover/fields.tsx"),w=s("./app/utils/discover/types.tsx"),x=s("./app/views/dashboardsV2/types.tsx");function Z(e){return i()(e)}function R(e,t,s,r){const{start:i,end:n,period:o}=s.datetime,{projects:a,environments:l}=s,d=r!==x.FO.WORLD_MAP||t.columns.includes("geo.country_code")?[...t.columns,...t.aggregates]:["geo.country_code",...t.columns,...t.aggregates],u=r!==x.FO.WORLD_MAP||t.conditions.includes("has:geo.country_code")?t.conditions:`${t.conditions} has:geo.country_code`.trim();return y.ZP.fromSavedQuery({id:void 0,name:e,version:2,fields:d,query:u,orderby:t.orderby,projects:a,range:null!=o?o:void 0,start:i?(0,f.v5)(i):void 0,end:n?(0,f.v5)(n):void 0,environment:l})}function S(e){return"string"==typeof e?[e]:e}function M(e){if(e){const t=S(e.queryNames),s=S(e.queryConditions),r=S(e.queryFields),i=[];if(s&&t&&r&&"string"==typeof e.queryOrderby){const{columns:n,aggregates:o}=(0,b.n0)(r);s.forEach(((s,a)=>{i.push({name:t[a],conditions:s,fields:r,columns:n,aggregates:o,orderby:e.queryOrderby})}))}if(e.title&&e.displayType&&e.interval&&i.length>0)return{...o()(e,["title","displayType","interval"]),widgetType:x.l9.DISCOVER,queries:i}}}function _(e){switch(e){case x.FO.BAR:return d;case x.FO.AREA:case x.FO.TOP_N:return l;case x.FO.BIG_NUMBER:return u;case x.FO.TABLE:return p;case x.FO.WORLD_MAP:return g;case x.FO.LINE:default:return c}}function j(e,t){let s="bar"===e.displayType?"1d":e.interval;s||(s="5m");const r=(0,f.YJ)(s);if((0,h.Nm)(t)/(60*r)>66){const e=(0,h.ZS)(t,"high");if(r<(0,f.YJ)(e))return e}return s}function q(e){const t=new Set;return e.filter(b.GO).forEach((e=>{const s=(0,m.W9)((0,b.bQ)(e)).tc;s.fields.forEach((e=>{let{term:s}=e;return t.add(s)})),s.functions.forEach((e=>{let{term:s}=e;return t.add(s)}))})),Array.from(t)}function F(e,t,s){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const i=R(e.title,e.queries[r],t,e.displayType),n=i.getResultsViewUrlTarget(s.slug),o=i.getYAxisOptions().map((e=>{let{value:t}=e;return t}));switch(n.query.yAxis=[...new Set(e.queries[0].aggregates.filter((e=>o.includes(e))))].slice(0,3),e.displayType){case x.FO.WORLD_MAP:n.query.display=w.DC.WORLDMAP;break;case x.FO.BAR:n.query.display=w.DC.BAR;break;case x.FO.TOP_N:n.query.display=w.DC.TOP5;const t=e.queries[0].aggregates;n.query.yAxis=t[t.length-1],t.slice(0,-1).includes(t[t.length-1])&&(n.query.field=t.slice(0,-1))}const l=n.query.field,d=e.queries[0],u=(0,v.ri)(d.fields)?d.fields:[...d.columns,...d.aggregates],c=q(u);c.forEach((e=>{Array.isArray(l)&&!l.includes(e)&&l.unshift(e)}));const p=`${n.pathname}?${a.stringify({...n.query})}`;return p}function T(e,t,s){var r,i,n,o;const{start:l,end:d,utc:u,period:c}=t.datetime,p=l&&d?{start:(0,f.v5)(l),end:(0,f.v5)(d),utc:u}:{statsPeriod:c};return`/organizations/${s.slug}/issues/?${a.stringify({query:null===(r=e.queries)||void 0===r||null===(i=r[0])||void 0===i?void 0:i.conditions,sort:null===(n=e.queries)||void 0===n||null===(o=n[0])||void 0===o?void 0:o.orderby,...p})}`}},"./app/views/dashboardsV2/widgetCard/issueWidgetQueries.tsx":(e,t,s)=>{s.d(t,{Z:()=>x});var r=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/react/index.js")),n=s("../node_modules/lodash/isEqual.js"),o=s.n(n),a=s("./app/components/organizations/pageFilters/utils.tsx"),l=s("./app/locale.tsx"),d=s("./app/stores/groupStore.tsx"),u=s("./app/stores/memberListStore.tsx"),c=s("./app/utils/dates.tsx"),p=s("./app/utils/getDynamicText.tsx"),g=s("./app/utils/stream.tsx"),m=s("./app/views/issueList/utils.tsx"),h=s("./app/views/dashboardsV2/types.tsx"),v=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const f=m.qh.DATE,y=m.io.EVENTS,b=["owners"];class w extends i.Component{constructor(){super(...arguments),(0,r.Z)(this,"state",{loading:!0,errorMessage:void 0,tableResults:[],memberListStoreLoaded:u.Z.isLoaded(),totalCount:null,pageLinks:null}),(0,r.Z)(this,"unlisteners",[u.Z.listen((()=>{this.setState({memberListStoreLoaded:u.Z.isLoaded()})}),void 0)])}componentDidMount(){this.fetchData()}componentDidUpdate(e){const{selection:t,widget:s,cursor:r}=this.props,[i]=e.widget.queries.reduce(((e,t)=>{let[s,r]=e,{name:i,...n}=t;return s.push(n),r.push(i),[s,r]}),[[],[]]),[n]=s.queries.reduce(((e,t)=>{let[s,r]=e,{name:i,...n}=t;return s.push(n),r.push(i),[s,r]}),[[],[]]);o()(s.displayType,e.widget.displayType)&&o()(s.interval,e.widget.interval)&&o()(n,i)&&o()(s.displayType,e.widget.displayType)&&(0,a.WO)(t,e.selection)&&r===e.cursor||this.fetchData()}componentWillUnmount(){this.unlisteners.forEach((e=>null==e?void 0:e()))}transformTableResults(){const{selection:e,widget:t}=this.props,{tableResults:s}=this.state;d.Z.add(s);const r=[];return s.forEach((s=>{let{id:i,shortId:n,title:o,lifetime:a,filtered:l,count:d,userCount:u,project:p,annotations:h,...v}=s;const f={};Object.keys(v).filter((e=>["number","string"].includes(typeof v[e]))).forEach((e=>{f[e]=v[e]}));const y={...f,events:d,users:u,id:i,"issue.id":i,issue:n,title:o,project:p.slug,links:null==h?void 0:h.join(", ")};a&&(y.lifetimeEvents=null==a?void 0:a.count,y.lifetimeUsers=null==a?void 0:a.userCount),l&&(y.filteredEvents=null==l?void 0:l.count,y.filteredUsers=null==l?void 0:l.userCount);const b=t.queries[0].conditions,w=[];if("string"==typeof b){const e=(0,g.w)(b);for(const t in e)if(!m.QL.includes(t)){const s=e[t].includes(" ")?`"${e[t]}"`:e[t];w.push(`${t}:${s}`)}e.__text&&w.push(e.__text)}y.discoverSearchQuery=(w.length?" ":"")+w.join(" "),y.projectId=p.id;const{period:x,start:Z,end:R}=e.datetime||{};Z&&R&&(y.start=(0,c.v5)(Z),y.end=(0,c.v5)(R)),y.period=null!=x?x:"",r.push(y)})),r}async fetchIssuesData(){const{selection:e,api:t,organization:s,widget:r,limit:i,cursor:n}=this.props;this.setState({tableResults:[]});const o=r.queries[0],a=`/organizations/${s.slug}/issues/`,d={project:e.projects,environment:e.environments,query:o.conditions,sort:o.orderby||f,display:y,expand:b,limit:null!=i?i:h.$V,cursor:n};e.datetime.period&&(d.statsPeriod=e.datetime.period),e.datetime.end&&(d.end=(0,c.v5)(e.datetime.end)),e.datetime.start&&(d.start=(0,c.v5)(e.datetime.start)),e.datetime.utc&&(d.utc=e.datetime.utc);try{var u,p;const[e,s,r]=await t.requestPromise(a,{includeAllArgs:!0,method:"GET",data:{...d}});this.setState({loading:!1,errorMessage:void 0,tableResults:e,totalCount:null!==(u=null==r?void 0:r.getResponseHeader("X-Hits"))&&void 0!==u?u:null,pageLinks:null!==(p=null==r?void 0:r.getResponseHeader("Link"))&&void 0!==p?p:null})}catch(e){var g,m;const t=null!==(g=null==e||null===(m=e.responseJSON)||void 0===m?void 0:m.detail)&&void 0!==g?g:null;this.setState({loading:!1,errorMessage:null!=t?t:(0,l.t)("Unable to load Widget"),tableResults:[]})}}fetchData(){this.setState({loading:!0,errorMessage:void 0}),this.fetchIssuesData()}render(){const{children:e}=this.props,{loading:t,errorMessage:s,memberListStoreLoaded:r,pageLinks:i}=this.state,n=this.transformTableResults();return(0,p.Z)({value:e({loading:t||!r,transformedResults:n,errorMessage:s,pageLinks:i}),fixed:(0,v.tZ)("div",{})})}}w.displayName="IssueWidgetQueries";const x=w},"./app/views/dashboardsV2/widgetCard/widgetCardChartContainer.tsx":(e,t,s)=>{s.d(t,{b:()=>he,Z:()=>ve});var r=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),i=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/react/index.js")),n=s("../node_modules/react-router/es/index.js"),o=s("./app/components/charts/errorPanel.tsx"),a=s("./app/components/panels/panelTable.tsx"),l=s("./app/components/tooltip.tsx"),d=s("./app/components/truncate.tsx"),u=s("./app/styles/space.tsx"),c=s("./app/utils/discover/fieldRenderers.tsx"),p=s("./app/utils/discover/fields.tsx"),g=s("./app/utils/withOrganization.tsx"),m=s("./app/views/eventsV2/table/topResultsIndicator.tsx"),h=s("./app/views/eventsV2/utils.tsx"),v=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class f extends i.Component{renderRow(e,t,s,r){const{location:i,organization:n,getCustomFieldRenderer:o,topResultsIndicators:a}=this.props;return r.map(((r,l)=>{var d;const u=(null!==(d=null==o?void 0:o(r.key,s))&&void 0!==d?d:(0,c.Js)(r.key,s))(t,{organization:n,location:i});return(0,v.BX)(x,{children:[a&&0===l&&(0,v.tZ)(m.Z,{count:a,index:e}),u]},`${e}-${l}:${r.name}`)}))}render(){const{className:e,loading:t,fields:s,metadata:r,data:n,title:o,fieldHeaderMap:a,stickyHeaders:d}=this.props,u=null!=r?r:{},c=(0,h.Hg)(s.map((e=>({field:e}))));return(0,v.BX)(i.Fragment,{children:[o&&(0,v.tZ)("h4",{children:o}),(0,v.tZ)(b,{className:e,isLoading:t,headers:c.map(((e,t)=>{var s;const r=(0,p.qG)(e.name,e.type,u),i=null!==(s=null==a?void 0:a[e.key])&&void 0!==s?s:e.name;return(0,v.tZ)(w,{align:r,children:(0,v.tZ)(l.Z,{title:i,children:(0,v.tZ)(y,{value:i,maxLength:30,expandable:!1})})},t)})),isEmpty:!(null!=n&&n.length),stickyHeaders:d,disablePadding:!0,children:null==n?void 0:n.map(((e,t)=>this.renderRow(t,e,u,c)))})]})}}f.displayName="SimpleTableChart";const y=(0,r.Z)(d.Z,{target:"e3tr8vk3"})({name:"1bmnxg7",styles:"white-space:nowrap"}),b=(0,r.Z)(a.Z,{target:"e3tr8vk2"})("border-radius:0;border-left:0;border-right:0;border-bottom:0;margin:0;",a.z,"{height:min-content;}"),w=(0,r.Z)("div",{target:"e3tr8vk1"})((e=>e.align?`text-align: ${e.align};`:"")," padding:",(0,u.Z)(1)," ",(0,u.Z)(3),";"),x=(0,r.Z)("div",{target:"e3tr8vk0"})("padding:",(0,u.Z)(1)," ",(0,u.Z)(3),";"),Z=(0,g.Z)(f);var R=s("./app/components/charts/transparentLoadingMask.tsx"),S=s("./app/components/loadingIndicator.tsx"),M=s("./app/components/placeholder.tsx"),_=s("./app/icons/index.tsx"),j=s("./app/utils.tsx"),q=s("./app/utils/dashboards/issueFieldRenderers.tsx"),F=s("./app/views/dashboardsV2/types.tsx"),T=s("./app/views/dashboardsV2/widgetBuilder/issueWidget/fields.tsx"),C=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),D=s("../node_modules/@emotion/react/dist/emotion-element-a8309070.browser.esm.js"),O=s("../node_modules/lodash/isEqual.js"),E=s.n(O),L=s("../node_modules/lodash/omit.js"),k=s.n(L),z=s("./app/components/charts/areaChart.tsx"),P=s("./app/components/charts/barChart.tsx"),I=s("./app/components/charts/chartZoom.tsx"),A=s("./app/components/charts/lineChart.tsx"),$=s("./app/components/charts/transitionChart.tsx"),N=s("./app/components/charts/utils.tsx"),B=s("./app/components/charts/worldMapChart.tsx"),V=s("./app/utils/discover/charts.tsx"),W=s("./app/utils/getDynamicText.tsx");class U extends i.Component{constructor(){super(...arguments),(0,C.Z)(this,"state",{containerHeight:0})}shouldComponentUpdate(e,t){var s,r;if(this.props.widget.displayType===F.FO.BIG_NUMBER&&e.widget.displayType===F.FO.BIG_NUMBER&&(this.props.windowWidth!==e.windowWidth||!E()(null===(s=this.props.widget)||void 0===s?void 0:s.layout,null===(r=e.widget)||void 0===r?void 0:r.layout)))return!0;const i={...k()(this.props,["windowWidth"]),widget:{...this.props.widget,title:""}};return e={...k()(e,["windowWidth"]),widget:{...e.widget,title:""}},!E()(i,e)||!E()(this.state,t)}tableResultComponent(e){let{loading:t,errorMessage:s,tableResults:r}=e;const{location:i,widget:n,organization:a}=this.props;return s?(0,v.tZ)(o.Z,{children:(0,v.tZ)(_.FC,{color:"gray500",size:"lg"})}):void 0===r||t?(0,v.tZ)(Q,{height:"200px"}):r.map(((e,s)=>{var o,l;const d=null!==(o=null===(l=n.queries[s])||void 0===l?void 0:l.fields)&&void 0!==o?o:[];return(0,v.tZ)(K,{location:i,fields:d,title:r.length>1?e.title:"",loading:t,metadata:e.meta,data:e.data,organization:a,stickyHeaders:!0,getCustomFieldRenderer:(e,t)=>(0,c.Js)(e,t,n.widgetType!==F.l9.METRICS)},`table:${e.title}`)}))}bigNumberComponent(e){let{loading:t,errorMessage:s,tableResults:r}=e;if(s)return(0,v.tZ)(o.Z,{children:(0,v.tZ)(_.FC,{color:"gray500",size:"lg"})});if(void 0===r||t)return(0,v.tZ)(J,{children:"â€”"});const{containerHeight:i}=this.state,{organization:n,widget:a,isMobile:d}=this.props;return r.map((e=>{var t;const s=null!==(t=e.meta)&&void 0!==t?t:{},r=Object.keys(null!=s?s:{})[0];if(!r||!e.data.length)return(0,v.tZ)(J,{children:"â€”"},`big_number:${e.title}`);const o=e.data[0],p=(0,c.fK)(r,s,a.widgetType!==F.l9.METRICS)(o),g=!(a.id||a.tempId);if(!n.features.includes("dashboard-grid-layout")||g||d)return(0,v.tZ)(J,{children:p},`big_number:${e.title}`);const m=i-parseInt((0,u.Z)(1),10)-parseInt((0,u.Z)(3),10);return(0,v.tZ)(J,{style:{fontSize:m},children:(0,v.tZ)(l.Z,{title:p,showOnlyOnOverflow:!0,children:p})},`big_number:${e.title}`)}))}chartComponent(e){const{widget:t}=this.props;switch(t.displayType){case"bar":return(0,v.tZ)(P.Z,{...e});case"area":case"top_n":return(0,v.tZ)(z.Z,{stacked:!0,...e});case"world_map":return(0,v.tZ)(B.Z,{...e});case"line":default:return(0,v.tZ)(A.Z,{...e})}}render(){var e,t,s;const{theme:r,tableResults:i,timeseriesResults:n,errorMessage:a,loading:l,widget:d,organization:u,onZoom:c,legendOptions:g}=this.props;if("table"===d.displayType)return(0,W.Z)({value:(0,v.BX)($.Z,{loading:l,reloading:l,children:[(0,v.tZ)(X,{loading:l}),this.tableResultComponent({tableResults:i,loading:l,errorMessage:a})]}),fixed:(0,v.tZ)(M.Z,{height:"200px",testId:"skeleton-ui"})});if("big_number"===d.displayType)return(0,v.BX)($.Z,{loading:l,reloading:l,children:[(0,v.tZ)(X,{loading:l}),(0,v.tZ)(G,{ref:e=>{if(null!==e){const{height:t}=e.getBoundingClientRect();this.setState({containerHeight:t})}},children:this.bigNumberComponent({tableResults:i,loading:l,errorMessage:a})})]});if(a)return(0,v.tZ)(o.Z,{children:(0,v.tZ)(_.FC,{color:"gray500",size:"lg"})});const{location:m,router:h,selection:f,onLegendSelectChanged:y}=this.props,{start:b,end:w,period:x,utc:Z}=f.datetime,R=Boolean(u.features.includes("dashboard-grid-layout")&&(d.id||d.tempId));if("world_map"===d.displayType){const{data:e,title:t}=(0,N.JT)(i),s=[{seriesName:t,data:e}];return(0,v.BX)($.Z,{loading:l,reloading:l,children:[(0,v.tZ)(X,{loading:l}),(0,v.tZ)(Y,{autoHeightResize:R,children:(0,W.Z)({value:this.chartComponent({series:s,autoHeightResize:R}),fixed:(0,v.tZ)(M.Z,{height:"200px",testId:"skeleton-ui"})})})]})}const S={left:0,top:0,selected:(0,N.RI)(m),formatter:e=>{const t=(0,p.hW)(e);if(null!==t){const s=(0,p.b8)(t);null!==s&&(e=s.toUpperCase())}return(0,p.by)(e)&&(e=(0,p.bQ)(e)),e},...g},j=null!==(e=null===(t=d.queries[0])||void 0===t||null===(s=t.aggregates)||void 0===s?void 0:s[0])&&void 0!==e?e:"count()",q=(0,p.GO)(j)?(0,p.vp)(j):j,F={autoHeightResize:R,grid:{left:4,right:0,top:"40px",bottom:0},seriesOptions:{showSymbol:!1},tooltip:{trigger:"axis",valueFormatter:V.CX},yAxis:{axisLabel:{color:r.chartLabel,formatter:e=>(0,V.gu)(e,q)}}};return(0,v.tZ)(I.Z,{router:h,period:x,start:b,end:w,utc:Z,children:e=>{if(a)return(0,v.tZ)(o.Z,{children:(0,v.tZ)(_.FC,{color:"gray500",size:"lg"})});const t=n?r.charts.getColorPalette(n.length-2):[];"top_n"===d.displayType&&n&&n.length>5&&(t[t.length-1]=r.chartOther);const s=n?n.map(((e,s)=>{let r="";return void 0!==e.seriesName&&(r=(0,p.GO)(e.seriesName)?(0,p.vp)(e.seriesName):e.seriesName),{...e,seriesName:r,color:t[s]}})):[];return(0,v.BX)($.Z,{loading:l,reloading:l,children:[(0,v.tZ)(X,{loading:l}),(0,v.tZ)(Y,{autoHeightResize:R,children:(0,W.Z)({value:this.chartComponent({...e,...F,...c?{onDataZoom:c}:{},legend:S,series:s,onLegendSelectChanged:y}),fixed:(0,v.tZ)(M.Z,{height:"200px",testId:"skeleton-ui"})})})]})}})}}U.displayName="WidgetCardChart";const H=(0,r.Z)((e=>(0,v.tZ)(R.Z,{...e,maskBackgroundColor:"transparent"})),{target:"eb7j3e5"})({name:"1vcob1d",styles:"display:flex;justify-content:center;align-items:center"}),X=e=>{let{loading:t}=e;return t?(0,v.tZ)(H,{visible:t,children:(0,v.tZ)(S.Z,{mini:!0})}):null};X.displayName="LoadingScreen";const Q=(0,r.Z)(M.Z,{target:"eb7j3e4"})("background-color:",(e=>e.theme.surface200),";"),G=(0,r.Z)("div",{target:"eb7j3e3"})({name:"af8mp8",styles:"height:100%;width:100%;overflow:hidden"}),J=(0,r.Z)("div",{target:"eb7j3e2"})("line-height:1;display:inline-flex;flex:1;width:100%;min-height:0;font-size:32px;color:",(e=>e.theme.headingColor),";padding:",(0,u.Z)(1)," ",(0,u.Z)(3)," ",(0,u.Z)(3)," ",(0,u.Z)(3),";*{text-align:left!important;}"),Y=(0,r.Z)("div",{target:"eb7j3e1"})((e=>e.autoHeightResize&&"height: 100%;")," padding:0 ",(0,u.Z)(3)," ",(0,u.Z)(3),";"),K=(0,r.Z)(Z,{target:"eb7j3e0"})("margin-top:",(0,u.Z)(1.5),";border-bottom-left-radius:",(e=>e.theme.borderRadius),";border-bottom-right-radius:",(e=>e.theme.borderRadius),";font-size:",(e=>e.theme.fontSizeMedium),";box-shadow:none;"),ee=(0,D.b)(U);var te=s("./app/views/dashboardsV2/widgetCard/issueWidgetQueries.tsx"),se=s("../node_modules/lodash/cloneDeep.js"),re=s.n(se),ie=s("./app/actionCreators/metrics.tsx"),ne=s("./app/components/organizations/pageFilters/utils.tsx"),oe=s("./app/locale.tsx"),ae=s("./app/utils/discover/types.tsx");function le(e,t){var s;return null!==(s=null==e?void 0:e.groups.flatMap((s=>Object.keys(s.series).map((r=>({seriesName:`${t?`${t}: `:""}${r}${Object.entries(s.by).map((e=>{let[t,s]=e;return`|${t}:${s}`})).join("")}`,data:e.intervals.map(((e,t)=>{var i;return{name:e,value:null!==(i=s.series[r][t])&&void 0!==i?i:0}}))}))))))&&void 0!==s?s:[]}var de=s("./app/utils/metrics/fields.tsx");function ue(e){return Object.keys(null!=e?e:{}).reduce(((e,t)=>{var s,r;return e[t]=null!==(s=de.Tz[null!==(r=(0,p.hW)(t))&&void 0!==r?r:t])&&void 0!==s?s:"string",e}),{})}var ce=s("./app/views/dashboardsV2/utils.tsx");class pe extends i.Component{constructor(){super(...arguments),(0,C.Z)(this,"state",{loading:!0,queryFetchID:void 0,errorMessage:void 0,timeseriesResults:void 0,rawResults:void 0,tableResults:void 0}),(0,C.Z)(this,"_isMounted",!1)}componentDidMount(){this._isMounted=!0,this.fetchData()}componentDidUpdate(e){const{loading:t,rawResults:s}=this.state,{selection:r,widget:i,organization:n,limit:o}=this.props,a=["queries","title","id","layout","tempId","widgetType"],l=["name","fields","aggregates","columns"],d=i.queries.map((e=>e.name)),u=e.widget.queries.map((e=>e.name));o===e.limit&&n.slug===e.organization.slug&&(0,ne.WO)(r,e.selection)&&E()(k()(i,a),k()(e.widget,a))&&E()(i.queries.map((e=>k()(e,l))),e.widget.queries.map((e=>k()(e,l))))&&E()(i.queries.flatMap((e=>{var t;return null===(t=e.fields)||void 0===t?void 0:t.filter((e=>!!e))})),e.widget.queries.flatMap((e=>{var t;return null===(t=e.fields)||void 0===t?void 0:t.filter((e=>!!e))})))&&E()(i.queries.flatMap((e=>e.aggregates.filter((e=>!!e)))),e.widget.queries.flatMap((e=>e.aggregates.filter((e=>!!e)))))&&E()(i.queries.flatMap((e=>e.columns.filter((e=>!!e)))),e.widget.queries.flatMap((e=>e.columns.filter((e=>!!e)))))?t||E()(d,u)||(null==s?void 0:s.length)!==i.queries.length||this.setState((e=>{var t;return{...e,timeseriesResults:null===(t=e.rawResults)||void 0===t?void 0:t.flatMap(((e,t)=>le(e,i.queries[t].name)))}})):this.fetchData()}componentWillUnmount(){this._isMounted=!1}get limit(){const{limit:e}=this.props;switch(this.props.widget.displayType){case F.FO.TOP_N:return ae.hY;case F.FO.TABLE:return null!=e?e:F.$V;case F.FO.BIG_NUMBER:return 1;default:return 20}}fetchData(){const{selection:e,api:t,organization:s,widget:r}=this.props;if(r.displayType===F.FO.WORLD_MAP)return void this.setState({errorMessage:(0,oe.t)("World Map is not supported by metrics.")});const i=Symbol("queryFetchID");this.setState({loading:!0,errorMessage:void 0,timeseriesResults:[],rawResults:[],tableResults:[],queryFetchID:i});const{environments:n,projects:o,datetime:a}=e,{start:l,end:d,period:u}=a,c=(0,ce.s)(r,{start:l,end:d,period:u}),p=r.queries.map((e=>{const r={field:e.aggregates,orgSlug:s.slug,end:d,environment:n,groupBy:e.columns,interval:c,limit:this.limit,orderBy:e.orderby||(this.limit?e.aggregates[0]:void 0),project:o,query:e.conditions,start:l,statsPeriod:u};return(0,ie.bf)(t,r)}));let g=0;p.forEach((async(e,t)=>{try{const s=await e;if(!this._isMounted)return;this.setState((e=>{var n,o;if(e.queryFetchID!==i)return e;if([F.FO.TABLE,F.FO.BIG_NUMBER].includes(r.displayType)){var a,l,d;const i=function(e){var t;const s=null!==(t=null==e?void 0:e.groups.map(((e,t)=>({id:String(t),...e.by,...e.totals}))))&&void 0!==t?t:[],r=null==e?void 0:e.groups[0];return{meta:{...ue(null==r?void 0:r.by),...ue(null==r?void 0:r.totals)},data:s}}(s);return i.title=null!==(a=null===(l=r.queries[t])||void 0===l?void 0:l.name)&&void 0!==a?a:"",{...e,tableResults:[...null!==(d=e.tableResults)&&void 0!==d?d:[],i]}}const u=[...null!==(n=e.timeseriesResults)&&void 0!==n?n:[]],c=le(s,r.queries[t].name);c.forEach(((e,s)=>{u[t*c.length+s]=e}));const p=re()(null!==(o=e.rawResults)&&void 0!==o?o:[]);return p[t]=s,{...e,timeseriesResults:u,rawResults:p}}))}catch(e){var s;const t=(null==e||null===(s=e.responseJSON)||void 0===s?void 0:s.detail)||(0,oe.t)("An unknown error occurred.");this.setState({errorMessage:t})}finally{if(g++,!this._isMounted)return;this.setState((e=>e.queryFetchID!==i?e:{...e,loading:g!==p.length}))}}))}render(){const{children:e}=this.props,{loading:t,timeseriesResults:s,tableResults:r,errorMessage:i}=this.state;return e({loading:t,timeseriesResults:s,tableResults:r,errorMessage:i})}}pe.displayName="MetricsWidgetQueries";const ge=pe;var me=s("./app/views/dashboardsV2/widgetCard/widgetQueries.tsx");function he(e){let{location:t,router:s,api:r,organization:n,selection:a,widget:l,isMobile:d,renderErrorMessage:u,tableItemLimit:c,windowWidth:p,onZoom:g,onLegendSelectChanged:m,legendOptions:h}=e;function f(e){let{loading:s,errorMessage:r,transformedResults:i}=e;if(r)return(0,v.tZ)(o.Z,{children:(0,v.tZ)(_.FC,{color:"gray500",size:"lg"})});if(s)return(0,v.tZ)(be,{height:"200px"});const a=l.queries[0],d=(0,j.ri)(a.fields)?a.fields:[...a.columns,...a.aggregates];return(0,v.tZ)(we,{location:t,title:"",fields:d,loading:s,metadata:T.$L,data:i,organization:n,getCustomFieldRenderer:q.O,fieldHeaderMap:T.kh,stickyHeaders:!0})}return l.widgetType===F.l9.ISSUE?(0,v.tZ)(te.Z,{api:r,organization:n,widget:l,selection:a,limit:c,children:e=>{let{transformedResults:t,errorMessage:s,loading:r}=e;return(0,v.BX)(i.Fragment,{children:["function"==typeof u?u(s):null,(0,v.tZ)(ye,{loading:r}),f({transformedResults:t,loading:r,errorMessage:s})]})}}):l.widgetType===F.l9.METRICS?(0,v.tZ)(ge,{api:r,organization:n,widget:l,selection:a,limit:c,children:e=>{let{tableResults:r,timeseriesResults:o,errorMessage:c,loading:g}=e;return(0,v.BX)(i.Fragment,{children:["function"==typeof u?u(c):null,(0,v.tZ)(ee,{timeseriesResults:o,tableResults:r,errorMessage:c,loading:g,location:t,widget:l,selection:a,router:s,organization:n,isMobile:d,windowWidth:p})]})}}):(0,v.tZ)(me.Z,{api:r,organization:n,widget:l,selection:a,limit:c,children:e=>{let{tableResults:r,timeseriesResults:o,errorMessage:c,loading:f}=e;return(0,v.BX)(i.Fragment,{children:["function"==typeof u?u(c):null,(0,v.tZ)(ee,{timeseriesResults:o,tableResults:r,errorMessage:c,loading:f,location:t,widget:l,selection:a,router:s,organization:n,isMobile:d,windowWidth:p,onZoom:g,onLegendSelectChanged:m,legendOptions:h})]})}})}const ve=(0,n.withRouter)(he),fe=(0,r.Z)((e=>(0,v.tZ)(R.Z,{...e,maskBackgroundColor:"transparent"})),{target:"e14ay5ol2"})({name:"1vcob1d",styles:"display:flex;justify-content:center;align-items:center"}),ye=e=>{let{loading:t}=e;return t?(0,v.tZ)(fe,{visible:t,children:(0,v.tZ)(S.Z,{mini:!0})}):null};ye.displayName="LoadingScreen";const be=(0,r.Z)(M.Z,{target:"e14ay5ol1"})("background-color:",(e=>e.theme.surface200),";"),we=(0,r.Z)(Z,{target:"e14ay5ol0"})("margin-top:",(0,u.Z)(1.5),";border-bottom-left-radius:",(e=>e.theme.borderRadius),";border-bottom-right-radius:",(e=>e.theme.borderRadius),";font-size:",(e=>e.theme.fontSizeMedium),";box-shadow:none;")},"./app/views/dashboardsV2/widgetCard/widgetQueries.tsx":(e,t,s)=>{s.d(t,{Z:()=>w});var r=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/react/index.js")),n=s("../node_modules/lodash/cloneDeep.js"),o=s.n(n),a=s("../node_modules/lodash/isEqual.js"),l=s.n(a),d=s("./app/actionCreators/events.tsx"),u=s("./app/components/charts/utils.tsx"),c=s("./app/components/organizations/pageFilters/utils.tsx"),p=s("./app/locale.tsx"),g=s("./app/utils/discover/genericDiscoverQuery.tsx"),m=s("./app/utils/discover/types.tsx"),h=s("./app/views/dashboardsV2/types.tsx"),v=s("./app/views/dashboardsV2/utils.tsx");function f(e,t){var s;return{seriesName:t,data:null!==(s=null==e?void 0:e.data.map((e=>{let[t,s]=e;return{name:1e3*t,value:s.reduce(((e,t)=>{let{count:s}=t;return e+s}),0)}})))&&void 0!==s?s:[]}}function y(e,t){let s=[];const r=e.name;if((0,u.Xe)(t)){const e=Object.keys(t).map((e=>{const s=r?`${r} : ${e}`:e,i=t[e];return[i.order||0,f(i,s)]})).sort(((e,t)=>e[0]-t[0])).map((e=>e[1]));s=s.concat(e)}else{const i=e.aggregates[0],n=f(t,r?`${r} : ${i}`:i);s.push(n)}return s}class b extends i.Component{constructor(){super(...arguments),(0,r.Z)(this,"state",{loading:!0,queryFetchID:void 0,errorMessage:void 0,timeseriesResults:void 0,rawResults:void 0,tableResults:void 0,pageLinks:void 0}),(0,r.Z)(this,"_isMounted",!1)}componentDidMount(){this._isMounted=!0,this.fetchData()}componentDidUpdate(e){var t;const{selection:s,widget:r,cursor:i}=this.props,[n,o]=e.widget.queries.map((e=>(e.aggregates=e.aggregates.filter((e=>!!e)),e.columns=e.columns.filter((e=>!!e)),e))).reduce(((e,t)=>{let[s,r]=e,{name:i,...n}=t;return s.push(i),r.push(n),[s,r]}),[[],[]]),[a,d]=r.queries.map((e=>(e.aggregates=e.aggregates.filter((e=>!!e&&"equation|"!==e)),e.columns=e.columns.filter((e=>!!e&&"equation|"!==e)),e))).reduce(((e,t)=>{let[s,r]=e,{name:i,...n}=t;return s.push(i),r.push(n),[s,r]}),[[],[]]);l()(r.displayType,e.widget.displayType)&&l()(r.interval,e.widget.interval)&&l()(d,o)&&(0,c.WO)(s,e.selection)&&i===e.cursor?this.state.loading||l()(n,a)||(null===(t=this.state.rawResults)||void 0===t?void 0:t.length)!==r.queries.length||this.setState((e=>{const t=r.queries.reduce(((t,s,r)=>t.concat(y(s,e.rawResults[r]))),[]);return{...e,timeseriesResults:t}})):this.fetchData()}componentWillUnmount(){this._isMounted=!1}fetchEventData(e){const{selection:t,api:s,organization:r,widget:i,limit:n,cursor:o,pagination:a}=this.props;let l=[];const d=i.queries.map((e=>{const l=(0,v.tT)(i.title,e,t);let d="";const u={per_page:null!=n?n:h.$V,...a?{cursor:o}:{noPagination:!0}};if("table"===i.displayType)d=`/organizations/${r.slug}/eventsv2/`,u.referrer="api.dashboards.tablewidget";else if("big_number"===i.displayType)d=`/organizations/${r.slug}/eventsv2/`,u.per_page=1,u.referrer="api.dashboards.bignumberwidget";else{if("world_map"!==i.displayType)throw Error("Expected widget displayType to be either big_number, table or world_map");d=`/organizations/${r.slug}/events-geo/`,delete u.per_page,u.referrer="api.dashboards.worldmapwidget"}return(0,g.AA)(s,d,{...l.generateQueryStringObject(),...u})}));let u=0;d.forEach((async(t,s)=>{try{var r,n;const[o,a,c]=await t,p=o;if(p.title=null!==(r=null===(n=i.queries[s])||void 0===n?void 0:n.name)&&void 0!==r?r:"",l=[...l,p],!this._isMounted)return;this.setState((t=>t.queryFetchID!==e?t:{...t,tableResults:l,pageLinks:null==c?void 0:c.getResponseHeader("Link")}))}catch(e){var o;const t=(null==e||null===(o=e.responseJSON)||void 0===o?void 0:o.detail)||(0,p.t)("An unknown error occurred.");this.setState({errorMessage:t})}finally{if(u++,!this._isMounted)return;this.setState((t=>t.queryFetchID!==e?t:{...t,loading:u!==d.length}))}}))}fetchTimeseriesData(e,t){const{selection:s,api:r,organization:i,widget:n}=this.props;this.setState({timeseriesResults:[],rawResults:[]});const{environments:a,projects:l}=s,{start:u,end:c,period:g}=s.datetime,h=(0,v.s)(n,{start:u,end:c,period:g}),f=n.queries.map((e=>{let s;return"top_n"===n.displayType?(s={organization:i,interval:h,start:u,end:c,project:l,environment:a,period:g,query:e.conditions,yAxis:e.aggregates[e.aggregates.length-1],includePrevious:!1,referrer:`api.dashboards.widget.${t}-chart`,partial:!0,topEvents:m.hY,field:[...e.columns,...e.aggregates]},e.orderby&&(s.orderby=e.orderby)):s={organization:i,interval:h,start:u,end:c,project:l,environment:a,period:g,query:e.conditions,yAxis:e.aggregates,orderby:e.orderby,includePrevious:!1,referrer:`api.dashboards.widget.${t}-chart`,partial:!0},(0,d.lI)(r,s)}));let b=0;f.forEach((async(t,s)=>{try{const r=await t;if(!this._isMounted)return;this.setState((t=>{var i,a;if(t.queryFetchID!==e)return t;const l=[...null!==(i=t.timeseriesResults)&&void 0!==i?i:[]],d=y(n.queries[s],r);d.forEach(((e,t)=>{l[s*d.length+t]=e}));const u=o()(null!==(a=t.rawResults)&&void 0!==a?a:[]);return u[s]=r,{...t,timeseriesResults:l,rawResults:u}}))}catch(e){var r;const t=(null==e||null===(r=e.responseJSON)||void 0===r?void 0:r.detail)||(0,p.t)("An unknown error occurred.");this.setState({errorMessage:t})}finally{if(b++,!this._isMounted)return;this.setState((t=>t.queryFetchID!==e?t:{...t,loading:b!==f.length}))}}))}fetchData(){const{widget:e}=this.props,t=Symbol("queryFetchID");this.setState({loading:!0,errorMessage:void 0,queryFetchID:t}),["table","world_map","big_number"].includes(e.displayType)?this.fetchEventData(t):this.fetchTimeseriesData(t,e.displayType)}render(){const{children:e}=this.props,{loading:t,timeseriesResults:s,tableResults:r,errorMessage:i,pageLinks:n}=this.state;return e({loading:t,timeseriesResults:null==s?void 0:s.filter((e=>!!e)),tableResults:r,errorMessage:i,pageLinks:n})}}b.displayName="WidgetQueries";const w=b}}]);
//# sourceMappingURL=../sourcemaps/app_components_modals_widgetViewerModal_utils_tsx-app_views_dashboardsV2_widgetCard_widgetCar-7a3063.abc86755fb651fd9dac082f7ce7498d5.js.map